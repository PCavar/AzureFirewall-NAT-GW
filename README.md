## Integrate NAT gateway with Azure Firewall in a hub and spoke network for outbound connectivity with Terraform

#### THIS TYPE OF SETUPS IS MOSTLY FOR LARGE WORKLOADS - WHERE SNAT PORT EXHAUSTION COULD OCCUR

#### For production workloads, Azure recommends separating Azure Firewall and production workloads into a hub and spoke topology. Introducing NAT gateway into this setup is simple and can be done in just a couple short steps. First, deploy Azure Firewall to an Azure Firewall Subnet within the hub virtual network (VNet).Attach NAT gateway to the Azure Firewall Subnet and add up to 16 public IP addresses and you’re done. Once configured, NAT gateway becomes the default route for all outbound traffic from the Azure Firewall Subnet. This means that internet-directed traffic (traffic with the prefix 0.0.0.0/0) routed from the spoke Vnets to the Hub Vnet’s Azure Firewall Subnet will automatically use the NAT gateway to connect outbound. Because NAT gateway is fully managed by Azure, NAT gateway allocates SNAT ports and scales to meet your outbound connectivity needs automatically. No additional configurations are required.

#### Source: https://azure.microsoft.com/fr-fr/blog/scale-azure-firewall-snat-ports-with-nat-gateway-for-large-workloads/

### Setup is as following:
#### The NAT-Gateway is integrated in the AzureFirewallSubnet, along with the deployed Azure Firewall. Both the Firewall and NAT-Gateway receives a public ip. Only the Firewall receives a Private IP. The Hub & Spoke Vnets are peered and a route table is created located in the Spokes subnet "Workload Subnet". We create a route table route with the configuration that the next hop is the Firewalls Private IP in the Hub. We also create a Firewall policy which allows outbound access on port 80,443. This means all the traffic from the spoke traverses through the Hubs Firewall and because the VM doesn't have a public IP, NAT-Gateway translates the virtual machines Private IP address to it's (NAT-Gateways) Public IP address and out to the internet.